<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>TradingView — композитные графики без биржевых префиксов</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root { color-scheme: dark; }
  body{margin:0;background:#0b0f14;color:#e7edf3;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  header{position:sticky;top:0;z-index:5;display:flex;gap:12px;flex-wrap:wrap;align-items:center;
         padding:12px 16px;background:rgba(11,15,20,.7);backdrop-filter:blur(6px);border-bottom:1px solid #1e2836}
  .btn{border:1px solid #2a3650;background:#121926;color:#cfe3ff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.active{border-color:#4e8cff;background:#14233b}
  .grid{display:grid;gap:10px;padding:10px;grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
  .card{border:1px solid #1e2836;border-radius:14px;overflow:hidden;background:#0f141d;min-height:360px}
  .cap{display:flex;align-items:center;justify-content:center;color:#7c8aa5;height:360px}
  h3{margin:8px 10px 0;color:#9bb6ff;font-size:13px;letter-spacing:.4px}
</style>
</head>
<body>
  <header>
    <div style="font-weight:700">Композитные графики TradingView</div>
    <div>Таймфрейм:</div>
    <button class="btn tf" data-tf="60">1H</button>
    <button class="btn tf" data-tf="240">4H</button>
    <button class="btn tf" data-tf="D">1D</button>
    <button class="btn tf" data-tf="W">1W</button>
    <span style="width:14px"></span>
    <div>Тема:</div>
    <button class="btn theme" data-theme="dark">Dark</button>
    <button class="btn theme" data-theme="light">Light</button>
  </header>

  <main class="grid" id="grid"></main>

<script>
  // ---- список монет из URL или дефолтный ----
  const urlCoins = new URLSearchParams(location.search).get('coins');
  const COINS = (urlCoins ? urlCoins.split(',') :
    ['BTC','ETH','SOL','LINK','ARB','SUI','INJ','AVAX','ADA','POND']
  ).map(s=>s.trim().toUpperCase()).filter(Boolean);

  // Композитные CRYPTO:<COIN>USD работают для топ-монет.
  // Если какая-то монета не имеет композита, впиши точный тикер сюда (временно):
  // Пример: POND часто нет в композите → можно показать через KuCoin.
  const EXCEPT = {
    // 'POND': 'KUCOIN:PONDUSDT'
  };

  let state = { interval: '60', theme: 'dark' };

  const grid = document.getElementById('grid');

  function symbolFor(coin){
    if (EXCEPT[coin]) return EXCEPT[coin];
    return `CRYPTO:${coin}USD`; // без MEXC/BINANCE
  }

  function mountAll(){
    grid.innerHTML = '';
    COINS.forEach(coin=>{
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.innerHTML = `
        <h3>${coin}/USD</h3>
        <div class="tradingview-widget-container">
          <div class="tradingview-widget-container__widget"></div>
          <div class="cap">График загружается…</div>
        </div>`;
      grid.appendChild(wrap);

      // создаём embed-скрипт на каждую карточку
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.async = true;
      script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
      script.innerHTML = JSON.stringify({
        autosize: true,
        symbol: symbolFor(coin),
        interval: state.interval,       // '60','240','D','W'
        timezone: "Etc/UTC",
        theme: state.theme,             // 'dark' | 'light'
        style: "1",
        withdateranges: true,
        hide_side_toolbar: false,
        allow_symbol_change: false,
        locale: "ru",
        studies: [],
        details: false
      });

      const cont = wrap.querySelector('.tradingview-widget-container');
      cont.appendChild(script);

      // убрать заглушку, когда iframe вставится
      script.onload = () => {
        setTimeout(()=>{
          const cap = wrap.querySelector('.cap');
          if (cap) cap.remove();
        }, 1200);
      };
    });

    highlightControls();
  }

  function highlightControls(){
    document.querySelectorAll('.btn.tf').forEach(b=>b.classList.toggle('active', b.dataset.tf===state.interval));
    document.querySelectorAll('.btn.theme').forEach(b=>b.classList.toggle('active', b.dataset.theme===state.theme));
  }

  document.querySelectorAll('.btn.tf').forEach(b=>{
    b.addEventListener('click', ()=>{ state.interval = b.dataset.tf; mountAll(); });
  });
  document.querySelectorAll('.btn.theme').forEach(b=>{
    b.addEventListener('click', ()=>{ state.theme = b.dataset.theme; mountAll(); });
  });

  mountAll();
</script>
</body>
</html>
